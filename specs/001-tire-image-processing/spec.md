# Feature Specification: 轮胎图片后处理（按行业准则对输入图片打分）

**Feature Branch**: `001-tire-image-processing`
**Created**: 2025-02-13
**Status**: Draft
**Input**: User description: "基于Python后端通用项目原则，制定'轮胎图片后处理（按行业准则（多条）对输入图片打分）'项目的基准规范，包含：1. 轮胎图片打分接口的具体路径/接口名/接口功能描述/入参/出参；2. 轮胎图片分项打分接口的具体路径/函数名/函数功能描述/入参/出参；3. 图片处理模块的函数命名与异常处理，功能测试的函数命名与描述；4. 打分模块的函数命名与异常处理，功能测试的函数命名与描述；5. 分项打分模块的函数命名与异常处理，功能测试的函数命名与描述；6. 打分结果的输出格式规范。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 轮胎图片打分识别与分类 (Priority: P1)

**描述**：系统能够接收轮胎生产过程中拍摄的原始图片，根据行业准则对轮胎表面进行打分识别，将图片按不同类别（如胎面、胎侧、胎肩等）进行分类，并输出打分结果。

**Why this priority**：这是核心功能，所有其他打分和分析功能都依赖于对轮胎图片的准确识别和分类。没有准确的打分基础，后续的缺陷检测和数据分析将无法进行。

**Independent Test**：可以通过上传一张轮胎图片进行测试，验证系统是否能够正确识别图片中的轮胎区域，并按照行业准则进行分类打分。系统应返回打分类别和置信度分数。

**Acceptance Scenarios**：

1. **Given** 一张轮胎侧面图片，**When** 用户上传图片到打分识别接口，**Then** 系统应返回"胎面"分类及打分结果（位置、类型、置信度）
2. **Given** 一张包含胎侧花纹的图片，**When** 用户上传图片到打分识别接口，**Then** 系统应返回"胎侧"分类及花纹细节打分（方向、深度、类型）
3. **Given** 一张胎肩区域图片，**When** 用户上传图片到打分识别接口，**Then** 系统应返回"胎肩"分类及结构打分（层数、厚度、强度）
4. **Given** 一张非轮胎图片或质量不合格图片，**When** 用户上传图片到打分识别接口，**Then** 系统应返回明确的错误信息（无效输入、图像质量不达标）

---

### User Story 2 - 轮胎图片分项打分 (Priority: P1)

**描述**：对识别出的每个轮胎区域（胎面、胎侧、胎肩等），系统需要分别进行更细粒度的打分，评估各自的质量指标。

**Why this priority**：分项打分是质量评估的基础，需要与主打分同步完成，确保后续缺陷检测和最终报告有完整的数据支撑。

**Independent Test**：可以通过已知打分类别的轮胎图片进行测试，验证系统是否能够对每个区域进行细粒度打分，并返回正确的打分结果。测试应包含不同质量水平的图片样本。

**Acceptance Scenarios**：

1. **Given** 一张已识别为"胎面"的图片，**When** 调用胎面打分接口，**Then** 系统应返回胎面纹理深度、磨损程度、均匀性等打分
2. **Given** 一张已识别为"胎侧"的图片，**When** 调用胎侧打分接口，**Then** 系统应返回花纹类型、方向（左/右）、清晰度等打分
3. **Given** 一张已识别为"胎肩"的图片，**When** 调用胎肩打分接口，**Then** 系统应返回结构完整度、边缘质量、过渡平滑度等打分
4. **Given** 一张识别失败的图片，**When** 调用分项打分接口，**Then** 系统应返回错误代码及原因说明

---

### User Story 3 - 图片处理模块函数规范 (Priority: P2)

**描述**：定义图片处理、打分、检测等核心模块的函数命名规范、异常处理机制和单元测试覆盖。

**Why this priority**：规范化的代码是长期维护和团队协作的基础。命名规范和异常处理机制直接影响代码的可读性、可维护性和稳定性。

**Independent Test**：可以通过编写简单的调用示例和单元测试来验证函数命名是否符合规范，异常处理是否能够正确捕获和处理各类错误情况，以及单元测试是否覆盖主要功能路径。

**Acceptance Scenarios**：

1. **Given** 一段按照规范命名的函数代码，**When** 代码审查工具（如 pylint）检查命名规范，**Then** 所有函数应符合 PEP 8 命名规范，无警告
2. **Given** 函数内部发生参数错误、文件读取失败等异常，**When** 执行该函数，**Then** 异常应被正确捕获并记录，不应导致程序崩溃
3. **Given** 核心处理函数的单元测试套件，**When** 运行 pytest 测试，**Then** 所有测试应通过，代码覆盖率应达到 80% 以上
4. **Given** 新增的处理函数，**When** 运行自动化测试和代码质量检查（CI/CD），**Then** 新函数应通过所有检查，符合项目质量标准

---

### User Story 4 - 打分模块函数规范 (Priority: P2)

**描述**：定义打分算法模块的函数命名规范、异常处理机制和功能测试覆盖。

**Why this priority**：打分算法是业务核心，其准确性和稳定性直接影响产品质量。规范化的代码和完善的测试能够降低缺陷率，提高算法可靠性。

**Independent Test**：可以通过提供标准测试图片集来验证打分函数的准确性，同时验证异常处理对边缘情况和错误输入的处理是否正确。

**Acceptance Scenarios**：

1. **Given** 一张标准测试图片，**When** 调用打分函数，**Then** 应返回符合行业标准的打分结果
2. **Given** 多张不同类型的测试图片，**When** 批量调用打分函数，**Then** 所有打分应在合理时间内完成（单张 < 100ms），结果应一致
3. **Given** 空图片或损坏图片，**When** 调用打分函数，**Then** 应抛出明确的异常（ValueError 或自定义业务异常），不返回空结果
4. **Given** 打分函数功能测试用例，**When** 运行功能测试，**Then** 所有测试场景应通过，包括正常、边界和异常情况

---

### User Story 5 - 分项打分模块函数规范 (Priority: P2)

**描述**：定义分项打分模块（针对胎面、胎侧、胎肩等不同区域的专项打分）的函数命名规范、异常处理机制和测试覆盖。

**Why this priority**：分项打分是细粒度质量评估的关键，需要对不同轮胎区域有专门的处理逻辑和打分标准。

**Independent Test**：可以通过使用对应区域的测试图片集来验证每个分项打分函数的准确性，确保打分标准与行业准则一致。

**Acceptance Scenarios**：

1. **Given** 一张胎面区域的图片，**When** 调用胎面分项打分函数，**Then** 应返回胎面纹理深度、平整度、缺陷检测等专项打分
2. **Given** 一张胎侧区域的图片，**When** 调用胎侧分项打分函数，**Then** 应返回花纹类型、方向标识、清晰度等专项打分
3. **Given** 一张胎肩区域的图片，**When** 调用胎肩分项打分函数，**Then** 应返回结构完整性、边缘质量、过渡平滑度等专项打分
4. **Given** 分项打分函数，**When** 运行单元测试和集成测试，**Then** 所有测试应通过，打分结果应符合预期标准范围

---

### User Story 6 - 打分结果输出格式规范 (Priority: P2)

**描述**：定义打分结果的统一输出格式，包括 JSON 结构、字段命名、数据类型、错误码等规范，确保前后端和其他系统能够正确解析和使用。

**Why this priority**：标准化的输出格式是系统集成和数据分析的基础。清晰的格式规范能够减少对接成本，提高数据一致性。

**Independent Test**：可以通过解析输出结果来验证格式是否符合规范，包括字段完整性、类型正确性、必需字段存在等。

**Acceptance Scenarios**：

1. **Given** 完整的打分处理流程，**When** 系统输出打分结果，**Then** 结果应为标准 JSON 格式，包含所有必需字段（图片ID、打分类别、分项打分、置信度等）
2. **Given** 打分处理成功，**When** 解析输出 JSON，**Then** 所有字段类型应与定义一致，无解析错误
3. **Given** 打分处理失败，**When** 系统输出错误响应，**Then** 应包含错误码、错误描述、错误时间等标准错误信息字段
4. **Given** 前端接收打分结果，**When** 渲染打分界面，**Then** 所有打分数据应正确显示，不同质量等级应有对应的视觉标识（颜色、图标等）

---

## Requirements *(mandatory)*

### Functional Requirements

#### 核心打分功能

- **FR-001**: 系统必须能够接收轮胎图片作为输入（支持 JPG、PNG、WEBP 等常见图片格式）
- **FR-002**: 系统必须根据行业准则对轮胎图片进行主打分（胎面、胎侧、胎肩、胎圈等）
- **FR-003**: 系统必须对每个主打分类别进行分项打分（纹理、结构、缺陷等维度）
- **FR-004**: 打分结果必须包含置信度分数（0-100），以评估打分可靠性
- **FR-005**: 系统必须支持批量图片处理，单次请求最多处理 10 张图片
- **FR-006**: 系统必须支持异步处理模式，对于大批量图片处理任务返回任务ID供后续查询

#### 接口规范

- **FR-007**: 轮胎图片打分接口路径必须为 `/api/v1/tire/scoring/segmentation` [HTTP POST]
- **FR-008**: 轮胎图片分项打分接口路径必须为 `/api/v1/tire/scoring/detail/{segment_type}` [HTTP POST]，其中 segment_type 为胎面/胎侧/胎肩等
- **FR-009**: 所有接口必须包含入参和出参的完整描述，包括参数名称、类型、是否必填、取值范围、说明
- **FR-010**: 接口响应必须遵循统一格式，包含状态码、消息、数据、时间戳等标准字段
- **FR-011**: 接口必须支持内容协商，接受 application/json 和 multipart/form-data 格式
- **FR-012**: 接口必须包含 API 版本信息（如 v1），便于后续升级和兼容性管理

#### 函数命名规范

- **FR-013**: 图片处理模块函数必须使用动词+名词格式（如 `load_image`、`preprocess_image`、`detect_regions`）
- **FR-014**: 打分模块函数必须使用 `score_` 前缀+具体功能（如 `score_tread_pattern`、`score_sidewall_structure`、`score_shoulder_quality`）
- **FR-015**: 工具函数必须使用下划线命名（snake_case），类名使用大驼峰（PascalCase）
- **FR-016**: 函数名必须清晰表达功能意图，避免缩写（使用 `calculate_confidence` 而非 `calc_conf`）

#### 异常处理规范

- **FR-017**: 所有函数必须对输入参数进行验证，对于无效输入抛出 `ValueError` 或 `TypeError`
- **FR-018**: 图片加载失败必须捕获 `IOError`，并记录错误日志后抛出自定义业务异常
- **FR-019**: 打分计算异常必须定义专门的异常类（如 `ScoringError`、`ImageProcessingError`），包含错误码和描述
- **FR-020**: 外部依赖（如 OpenCV、NumPy）调用失败必须有 fallback 处理逻辑，不应导致进程崩溃

#### 测试规范

- **FR-021**: 每个函数必须有对应的单元测试，测试文件命名为 `test_<module_name>.py`
- **FR-022**: 测试用例必须包含正常场景、边界条件和异常情况的覆盖
- **FR-023**: 测试函数命名必须清晰描述测试意图（如 `test_score_tread_pattern_valid_input`、`test_score_tread_pattern_empty_image`）
- **FR-024**: 测试必须使用 pytest 框架，测试覆盖率应达到 80% 以上

#### 输出格式规范

- **FR-025**: 打分结果必须使用标准 JSON 格式输出
- **FR-026**: JSON 结构必须包含以下字段：`image_id`（字符串）、`segmentation`（对象）、`detail_scores`（数组）、`overall_score`（对象）、`confidence`（浮点数）
- **FR-027**: 分项打分必须包含：`segment_type`（字符串）、`score_items`（对象数组）、`total_score`（浮点数）
- **FR-028**: 错误响应必须包含：`error_code`（字符串）、`error_message`（字符串）、`timestamp`（ISO 8601 格式）
- **FR-029**: 所有打分值必须使用浮点数，保留 2 位小数

### Key Entities

- **TireImage**: 轮胎图片实体，包含图片数据、元数据（拍摄时间、设备信息等）
- **SegmentationResult**: 打分结果实体，包含打分类别、置信度、区域坐标
- **DetailScore**: 分项打分实体，包含具体打分项目、分数、评级
- **ScoringError**: 错误实体，包含错误码、错误信息、建议处理方式
- **AsyncTask**: 异步任务实体，包含任务ID、状态、进度、结果URL

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 单张轮胎图片主打分识别准确率达到 95% 以上（基于标注数据集测试）
- **SC-002**: 分项打分结果与人工打分的相关系数达到 0.85 以上
- **SC-003**: 单张图片处理延迟低于 100ms（不含网络传输时间）
- **SC-004**: 批量处理 10 张图片的 API 响应时间低于 500ms
- **SC-005**: 接口文档覆盖率达到 100%（所有接口都有完整的入参、出参说明）
- **SC-006**: 单元测试覆盖率达到 80% 以上
- **SC-007**: 代码审查工具（pylint、black）检查通过率达到 98% 以上
- **SC-008**: 异常处理覆盖率达到 95% 以上（所有预期错误都有捕获和处理）
- **SC-009**: API 响应格式与规范一致性达到 100%
- **SC-010**: 前端开发人员能够在 30 分钟内理解并集成打分接口

## Assumptions

- 图片输入来自生产线拍摄设备，图片质量基本稳定（无明显模糊、曝光问题）
- 行业准则打分标准参考 JT 轮胎生产规范文档
- 打分算法基于预训练模型或传统图像处理算法，具体技术选型在 plan 阶段确定
- 系统部署在 Linux 服务器，Python 版本为 3.12，使用 Conda 环境管理
- 图片存储和访问权限由独立的服务（如对象存储 S3/OSS）提供，本规范不涉及存储实现细节
